name: Auto Pull, Build, and Deploy on Push to Master

on:
  push:
    branches:
      - master
env:
  HOST: ${{ secrets.VIRTUAL_MACHINE_IP }}  
  USER: 'ubuntu'      
  REPO_DIR: '/home/ubuntu/A3_LOJA_ACAI/'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Configurar SSH para Acesso ao Servidor
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Realizar Pull de Repositório do Github
        run: |
          ssh -o StrictHostKeyChecking=no $USER@$HOST << 'EOF'
          cd $REPO_DIR
          ls
          echo "Fazendo pull do código mais recente..."
          git pull origin master
      
          if ! git diff-index --quiet HEAD --; then
            echo "Mudanças encontradas. Realizando commit e push..."
            git add .
            git commit -m "DB_CHANGES"
            git push origin master
          else
            echo "Nenhuma mudança encontrada. Pulando o commit e o push."
          fi
          EOF
      

      - name: Conectar, Fazer Pull e Construir Imagem no Servidor
        run: |
          ssh -o StrictHostKeyChecking=no $USER@$HOST << EOF
          cd $REPO_DIR
          echo "Construindo Containers..."
          docker-compose build

          echo "Parando e removendo containers antigos..."
          docker-compose down

          echo "Iniciando Containers..."
          docker-compose up --build -d > /dev/null 2>&1

          echo "Removendo imagens antigas não utilizadas..."
          docker image prune -f

          echo "Listando containers e imagens..."
          docker ps
          docker images
          EOF

